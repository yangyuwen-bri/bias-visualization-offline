<!DOCTYPE html>
<html lang="zh-CN" class="light-theme">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>åè§åˆ†æå…¬å¼€å±•ç¤º</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="css/tech-style.css">
    <link rel="stylesheet" href="css/light-theme.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ğŸ“Š</text></svg>">
    <style>
        .leaderboard-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .leaderboard-tabs {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .leaderboard-tab {
            border: 1px solid var(--tech-border, #e2e8f0);
            background: transparent;
            color: var(--tech-text-primary, #1f2937);
            padding: 0.45rem 1rem;
            border-radius: 999px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .leaderboard-tab:hover {
            border-color: var(--tech-accent, #58dedf);
            color: var(--tech-accent, #58dedf);
        }

        .leaderboard-tab.active {
            background: var(--tech-accent, #58dedf);
            color: #fff;
            border-color: transparent;
            box-shadow: 0 8px 18px rgba(88, 222, 223, 0.35);
        }

        .leaderboard-tab:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .leaderboard-filter {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--tech-text-secondary, #6b7280);
        }

        .leaderboard-summary {
            margin-bottom: 0.75rem;
        }

        .tech-card {
            position: relative;
            padding-top: 1rem;
        }

        .card-actions {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            z-index: 5;
        }

        .download-menu {
            position: relative;
        }

        .action-btn {
            background: var(--tech-accent, #58dedf);
            color: #fff;
            border: none;
            border-radius: 999px;
            padding: 0.35rem 0.85rem;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 8px 18px rgba(88, 222, 223, 0.35);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .action-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .menu-panel {
            position: absolute;
            top: calc(100% + 0.4rem);
            right: 0;
            background: #fff;
            border-radius: 0.6rem;
            box-shadow: 0 12px 32px rgba(15, 23, 42, 0.18);
            border: 1px solid var(--tech-border, rgba(203, 213, 225, 0.7));
            padding: 0.4rem;
            min-width: 200px;
            display: none;
        }

        .menu-panel.show {
            display: block;
        }

        .menu-panel a,
        .menu-panel button {
            display: block;
            width: 100%;
            padding: 0.45rem 0.6rem;
            border: none;
            background: transparent;
            text-align: left;
            font-size: 0.85rem;
            color: var(--tech-text-primary, #1f2937);
            border-radius: 0.45rem;
            cursor: pointer;
            transition: background 0.2s ease, color 0.2s ease;
        }

        .menu-panel a:hover,
        .menu-panel button:hover {
            background: rgba(88, 222, 223, 0.15);
            color: var(--tech-accent, #58dedf);
        }

        .menu-panel a {
            text-decoration: none;
        }

        .view-switch {
            display: inline-flex;
            background: rgba(88, 222, 223, 0.12);
            border-radius: 999px;
            padding: 0.2rem;
            backdrop-filter: blur(6px);
        }

        .view-btn {
            border: none;
            background: transparent;
            color: var(--tech-text-secondary, #64748b);
            font-size: 0.8rem;
            font-weight: 500;
            padding: 0.35rem 0.75rem;
            border-radius: 999px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .view-btn:hover {
            color: var(--tech-accent, #58dedf);
        }

        .view-btn.active {
            background: #fff;
            color: var(--tech-accent, #58dedf);
            box-shadow: 0 6px 15px rgba(88, 222, 223, 0.25);
        }

        .sortable {
            cursor: pointer;
            position: relative;
        }

        .sortable::after {
            content: 'â‡…';
            font-size: 0.75rem;
            margin-left: 0.35rem;
            color: var(--tech-text-muted, #94a3b8);
        }

        .sortable.sorted-asc::after {
            content: 'â†‘';
            color: var(--tech-accent, #58dedf);
        }

        .sortable.sorted-desc::after {
            content: 'â†“';
            color: var(--tech-accent, #58dedf);
        }

        #leaderboard-table tbody tr:nth-child(odd) {
            background-color: rgba(88, 222, 223, 0.08);
        }

        .subtle-note {
            margin: 0 0 0.85rem;
            font-size: 0.82rem;
            color: var(--tech-text-secondary, #64748b);
            padding-right: 6rem;
        }

        .tech-alert {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <header class="public-header">
        <h1>æ¨¡å‹åè§æ´å¯Ÿä¸­å¿ƒ</h1>
        <p>åŸºäºå·²ç”Ÿæˆçš„è¯„ä¼°æ•°æ®ï¼Œå±•ç¤ºå„æ¨¡å‹åœ¨éšæ€§ä¸æ˜¾æ€§åè§ä¸Šçš„è¡¨ç°</p>
    </header>

    <main class="public-container">
        <div id="data-status" class="tech-alert tech-alert-info" style="display:none;"></div>

        <div class="tech-card">
            <h3 class="tech-card-title">ç»¼åˆåè§æ¦œå•</h3>
            <p class="subtle-note">ç»¼åˆåè§å¾—åˆ†ï¼šéšæ€§ä¾§ä½¿ç”¨åˆ»æ¿ä¸€è‡´å¾—åˆ†ï¼ˆIBSï¼‰å’Œæ€§åˆ«è¯„ä»·å·®å¼‚ï¼ˆPBSï¼‰è¡¡é‡æ¨¡å‹æ˜¯å¦æ²¿ç”¨åˆ»æ¿å°è±¡åŠéšæ€§å€¾å‘å·®å¼‚ï¼›æ˜¾æ€§ä¾§ä½¿ç”¨å›ç­”åˆ†å¸ƒå·®å¼‚ï¼ˆEDSï¼‰ã€æƒ…æ™¯ä¸€è‡´æ€§å·®å¼‚ï¼ˆECSï¼‰ä¸æ€§åˆ«è¯„ä»·å·®å¼‚ï¼ˆPBSï¼‰è¡¡é‡é’ˆå¯¹ç”·å¥³å¥å­çš„è¡¨ç°å·®è·ã€‚æ•°å€¼è¶Šé«˜ä»£è¡¨åè§è¶Šæ˜æ˜¾ã€‚</p>
            <div class="card-actions">
                <div class="download-menu">
                    <button type="button" class="action-btn menu-trigger" data-menu="leaderboard-menu">ä¸‹è½½</button>
                    <div class="menu-panel" id="leaderboard-menu">
                        <a href="data/combined_overall.csv">ä¸‹è½½å…¨éƒ¨æ•°æ® (CSV)</a>
                        <button type="button" data-action="leaderboard-export-view">å¯¼å‡ºå½“å‰è§†å›¾ (CSV)</button>
                    </div>
                </div>
            </div>
            <div class="leaderboard-controls">
                <div class="leaderboard-tabs">
                    <button type="button" class="leaderboard-tab active" data-view="implicit">éšæ€§åè§</button>
                    <button type="button" class="leaderboard-tab" data-view="explicit">æ˜¾æ€§åè§</button>
                </div>
                <div class="leaderboard-filter">
                    <label for="leaderboard-topn">æ˜¾ç¤º</label>
                    <select id="leaderboard-topn" class="form-select">
                        <option value="5" selected>å‰ 5</option>
                        <option value="10">å‰ 10</option>
                        <option value="all">å…¨éƒ¨</option>
                    </select>
                </div>
            </div>
            <div id="leaderboard-summary" class="tech-text-muted leaderboard-summary"></div>
            <table class="tech-table" id="leaderboard-table">
                <thead id="leaderboard-head"></thead>
                <tbody id="leaderboard-body"></tbody>
            </table>
        </div>

        <div class="tech-card">
            <h3 class="tech-card-title">éšæ€§åè§å¯¹æ¯”</h3>
            <p class="subtle-note">éšæ€§æŒ‡æ ‡åŸºäºé…å¯¹å±æ€§è¯ï¼šåˆ»æ¿ä¸€è‡´å¾—åˆ†ï¼ˆIBSï¼‰è¶Šé«˜è¡¨ç¤ºæ¨¡å‹è¶Šå€¾å‘æ²¿ç”¨ä¼ ç»Ÿåˆ»æ¿å°è±¡ï¼Œæ€§åˆ«è¯„ä»·å·®å¼‚ï¼ˆPBSï¼‰è¶Šé«˜è¡¨ç¤ºç”·å¥³è·å¾—æ­£å‘/è´Ÿå‘å±æ€§çš„å·®è·è¶Šå¤§ã€‚</p>
            <div class="card-actions">
                <div class="view-switch">
                    <button type="button" class="view-btn active" data-view-group="implicit" data-view-mode="bar">æ¡å½¢å›¾</button>
                    <button type="button" class="view-btn" data-view-group="implicit" data-view-mode="radar">é›·è¾¾å›¾</button>
                </div>
                <div class="download-menu">
                    <button type="button" class="action-btn menu-trigger" data-menu="implicit-menu">ä¸‹è½½</button>
                    <div class="menu-panel" id="implicit-menu">
                        <a href="data/combined_metrics.csv">ä¸‹è½½ç»´åº¦æ•°æ® (CSV)</a>
                        <button type="button" data-chart-save="public-implicit-dbs" data-filename="éšæ€§åˆ»æ¿ä¸€è‡´æ€§.png">ä¿å­˜åˆ»æ¿ä¸€è‡´å›¾</button>
                        <button type="button" data-chart-save="public-implicit-pbs" data-filename="éšæ€§æ€§åˆ«è¯„ä»·å·®å¼‚.png">ä¿å­˜æ€§åˆ«å·®å¼‚å›¾</button>
                    </div>
                </div>
            </div>
            <div class="chart-grid chart-grid-vertical">
                <div class="chart-box">
                    <div id="public-implicit-dbs" style="height:360px;"></div>
                </div>
                <div class="chart-box">
                    <div id="public-implicit-pbs" style="height:360px;"></div>
                </div>
            </div>
        </div>

        <div class="tech-card">
            <h3 class="tech-card-title">æ˜¾æ€§åè§å¯¹æ¯”</h3>
            <p class="subtle-note">æ˜¾æ€§æŒ‡æ ‡æ¯”è¾ƒåŒä¸€æ¨¡å‹åœ¨é’ˆå¯¹å¥³æ€§ä¸ç”·æ€§å¥å­æ—¶çš„å›ç­”å·®è·ï¼šå›ç­”åˆ†å¸ƒå·®å¼‚ï¼ˆEDSï¼‰ã€æƒ…æ™¯ä¸€è‡´æ€§å·®å¼‚ï¼ˆECSï¼‰ä¸æ€§åˆ«è¯„ä»·å·®å¼‚ï¼ˆPBSï¼‰è¶Šé«˜ï¼Œè¯´æ˜è¯¥æ¨¡å‹å¯¹ä¸¤æ€§ä½¿ç”¨çš„æ ‡å‡†å·®å¼‚è¶Šæ˜æ˜¾ã€‚</p>
            <div class="card-actions">
                <div class="view-switch">
                    <button type="button" class="view-btn active" data-view-group="explicit" data-view-mode="bar">æ¡å½¢å›¾</button>
                    <button type="button" class="view-btn" data-view-group="explicit" data-view-mode="radar">é›·è¾¾å›¾</button>
                </div>
                <div class="download-menu">
                    <button type="button" class="action-btn menu-trigger" data-menu="explicit-menu">ä¸‹è½½</button>
                    <div class="menu-panel" id="explicit-menu">
                        <a href="data/combined_explicit_distribution.csv">å›ç­”åˆ†å¸ƒæ•°æ® (CSV)</a>
                        <a href="data/combined_explicit_context.csv">æƒ…æ™¯ä¸€è‡´æ€§æ•°æ® (CSV)</a>
                        <button type="button" data-chart-save="public-explicit-metrics" data-filename="æ€§åˆ«è¯„ä»·å·®å¼‚æ¦‚è§ˆ.png">ä¿å­˜å›¾åƒ</button>
                    </div>
                </div>
            </div>
            <div class="chart-grid">
                <div class="chart-box">
                    <div id="public-explicit-metrics" style="height:360px;"></div>
                </div>
            </div>
        </div>
    </main>

    <footer class="public-footer">
        å¦‚éœ€é‡æ–°ç”Ÿæˆæ•°æ®ï¼Œè¯·è¿è¡Œé¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ç¦»çº¿è„šæœ¬å¹¶æ›¿æ¢ <code>data/</code> ä¸­çš„æ–‡ä»¶ã€‚
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script>
        const DATA_PATH = 'data/';
        const REQUIRED_FILES = [
            'public_metrics.json',
            'public_overall.json',
        ];

        const colorPalette = [
            '#58dedf', '#3fc1eb', '#89b1fe', '#7282d6', '#5a8fff',
            '#6b7bff', '#4dcfff', '#8a6dff', '#3dd4f7', '#9085ff'
        ];

        const eeChartTheme = {
            color: colorPalette,
            textStyle: {
                color: '#000000',
                fontFamily: 'Inter, -apple-system, BlinkMacSystemFont, sans-serif',
            },
            tooltip: {
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                borderColor: 'rgba(203, 213, 225, 0.7)',
                textStyle: { color: '#000000' },
            },
            title: {
                textStyle: { color: '#000000' },
            },
            legend: {
                textStyle: { color: '#000000' },
            },
            categoryAxis: {
                axisLine: { lineStyle: { color: '#94a3b8' } },
                axisLabel: { color: '#475569' },
            },
            valueAxis: {
                axisLine: { lineStyle: { color: '#94a3b8' } },
                splitLine: { lineStyle: { color: 'rgba(148, 163, 184, 0.4)' } },
            },
        };
        echarts.registerTheme('ee-light', eeChartTheme);

        const sanitizeFileName = (text) => text.replace(/[\s%]+/g, '_');
        const hexToRgba = (hex, alpha = 0.12) => {
            let c = hex.replace('#', '');
            if (c.length === 3) {
                c = c.split('').map(ch => ch + ch).join('');
            }
            const r = parseInt(c.slice(0, 2), 16);
            const g = parseInt(c.slice(2, 4), 16);
            const b = parseInt(c.slice(4, 6), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        };

        const chartInstances = [];
        const chartMap = {};
        const createChart = (domId) => {
            if (chartMap[domId]) {
                return chartMap[domId];
            }
            const dom = document.getElementById(domId);
            if (!dom) return null;
            const chart = echarts.init(dom, 'ee-light');
            chartInstances.push(chart);
            chartMap[domId] = chart;
            return chart;
        };

        const state = {
            metricsData: [],
            overallData: [],
            implicitMetrics: [],
            explicitMetrics: [],
            implicitOverall: [],
            explicitOverall: [],
            implicitMetricMap: {},
            dimensions: [],
            dimensionLabels: {},
            implicitModels: [],
            chartView: {
                implicit: 'bar',
                explicit: 'bar',
            },
            explicitMetricKeys: ['eds', 'ecs', 'pbs'],
            explicitMetricLabels: {
                eds: 'å›ç­”åˆ†å¸ƒå·®å¼‚ (EDS)',
                ecs: 'æƒ…æ™¯ä¸€è‡´æ€§å·®å¼‚ (ECS)',
                pbs: 'æ€§åˆ«è¯„ä»·å·®å¼‚ (PBS)',
            },
        };

        const showStatus = (message, type = 'info') => {
            const statusEl = document.getElementById('data-status');
            statusEl.textContent = message;
            statusEl.className = `tech-alert tech-alert-${type}`;
            statusEl.style.display = 'block';
        };

        const hideStatus = () => {
            const statusEl = document.getElementById('data-status');
            statusEl.style.display = 'none';
        };

        const buildImplicitBarSeries = (metricKey) => {
            return state.implicitModels.map((model, idx) => {
                const values = state.dimensions.map(dim => {
                    const row = state.implicitMetricMap[`${model}|${dim}`];
                    return row ? row[metricKey] || 0 : 0;
                });
                return {
                    name: model,
                    type: 'bar',
                    barGap: '10%',
                    barCategoryGap: '40%',
                    data: values,
                    itemStyle: { color: colorPalette[idx % colorPalette.length] },
                };
            });
        };

        const getImplicitBarOption = (title, metricKey) => ({
            title: { text: title, left: 'center', textStyle: { color: '#3fc1eb', fontSize: 16, fontWeight: '600' } },
            tooltip: { trigger: 'axis' },
            legend: { top: 'bottom', data: state.implicitModels },
            grid: { left: '3%', right: '3%', bottom: '10%', containLabel: true },
            xAxis: { type: 'category', data: state.dimensions.map(dim => state.dimensionLabels[dim] || dim) },
            yAxis: { type: 'value', min: 0, max: 100 },
            series: buildImplicitBarSeries(metricKey),
            toolbox: {
                feature: {
                    saveAsImage: {
                        title: 'ä¿å­˜å›¾åƒ',
                        name: sanitizeFileName(title),
                        pixelRatio: 2,
                    },
                },
                right: 12,
                top: 12,
            },
        });

        const buildImplicitRadarSeries = (metricKey) => {
            return state.implicitModels.map((model, idx) => {
                const values = state.dimensions.map(dim => {
                    const row = state.implicitMetricMap[`${model}|${dim}`];
                    return row ? row[metricKey] || 0 : 0;
                });
                const color = colorPalette[idx % colorPalette.length];
                return {
                    name: model,
                    value: values,
                    lineStyle: { color, width: 2 },
                    areaStyle: { color: hexToRgba(color, 0.12) },
                    itemStyle: { color },
                    symbol: 'circle',
                    symbolSize: 6,
                };
            });
        };

        const getImplicitRadarOption = (title, metricKey) => ({
            title: { text: title, left: 'center', textStyle: { color: '#3fc1eb', fontSize: 16, fontWeight: '600' } },
            tooltip: { trigger: 'item' },
            legend: { top: 'bottom', data: state.implicitModels },
            radar: {
                indicator: state.dimensions.map(dim => ({
                    name: state.dimensionLabels[dim] || dim,
                    max: 100,
                })),
                radius: '65%',
                splitNumber: 4,
            },
            series: [
                {
                    type: 'radar',
                    data: buildImplicitRadarSeries(metricKey),
                },
            ],
            toolbox: {
                feature: {
                    saveAsImage: {
                        title: 'ä¿å­˜å›¾åƒ',
                        name: sanitizeFileName(title),
                        pixelRatio: 2,
                    },
                },
                right: 12,
                top: 12,
            },
        });

        const getExplicitBarOption = () => {
            const categories = state.explicitOverall.map(item => item.model);
            const metricSeries = state.explicitMetricKeys.map((key, idx) => ({
                key,
                label: state.explicitMetricLabels[key],
                data: state.explicitOverall.map(item => item[key] ?? 0),
                color: colorPalette[idx % colorPalette.length],
            }));
            const maxScore = Math.max(...metricSeries.flatMap(series => series.data), 0);
            const yMax = Math.ceil(maxScore / 5) * 5 || 5;
            return {
                title: { text: 'æ€§åˆ«è¯„ä»·å·®å¼‚æ¦‚è§ˆï¼ˆEDS / ECS / PBSï¼‰', left: 'center', textStyle: { color: '#3fc1eb', fontSize: 16, fontWeight: '600' } },
                tooltip: { trigger: 'axis' },
                legend: { top: 'bottom', data: metricSeries.map(series => series.label) },
                xAxis: {
                    type: 'category',
                    data: categories,
                    axisLabel: {
                        interval: 0,
                        rotate: categories.length > 6 ? 30 : 0,
                    },
                },
                yAxis: { type: 'value', min: 0, max: yMax },
                grid: { left: '3%', right: '3%', bottom: '10%', containLabel: true },
                toolbox: {
                    feature: {
                        saveAsImage: {
                            title: 'ä¿å­˜å›¾åƒ',
                            name: sanitizeFileName('æ€§åˆ«è¯„ä»·å·®å¼‚æ¦‚è§ˆï¼ˆEDS / ECS / PBSï¼‰'),
                            pixelRatio: 2,
                        },
                    },
                    right: 12,
                    top: 12,
                },
                series: metricSeries.map(series => ({
                    name: series.label,
                    type: 'bar',
                    barGap: '10%',
                    barCategoryGap: '30%',
                    data: series.data,
                    itemStyle: { color: series.color },
                })),
            };
        };

        const getExplicitRadarOption = () => {
            const maxScore = Math.max(...state.explicitMetricKeys.flatMap(key => state.explicitOverall.map(item => item[key] ?? 0)), 0);
            const yMax = Math.ceil(maxScore / 5) * 5 || 5;
            const indicators = state.explicitMetricKeys.map(key => ({
                name: state.explicitMetricLabels[key],
                max: yMax,
            }));
            return {
                title: { text: 'æ€§åˆ«è¯„ä»·å·®å¼‚æ¦‚è§ˆï¼ˆEDS / ECS / PBSï¼‰', left: 'center', textStyle: { color: '#3fc1eb', fontSize: 16, fontWeight: '600' } },
                tooltip: { trigger: 'item' },
                legend: { top: 'bottom', data: state.explicitOverall.map(item => item.model) },
                radar: {
                    indicator: indicators,
                    radius: '65%',
                    splitNumber: 4,
                },
                series: [
                    {
                        type: 'radar',
                        data: state.explicitOverall.map((item, idx) => {
                            const color = colorPalette[idx % colorPalette.length];
                            return {
                                name: item.model,
                                value: state.explicitMetricKeys.map(key => item[key] ?? 0),
                                lineStyle: { color, width: 2 },
                                itemStyle: { color },
                                areaStyle: { color: hexToRgba(color, 0.12) },
                                symbol: 'circle',
                                symbolSize: 6,
                            };
                        }),
                    },
                ],
                toolbox: {
                    feature: {
                        saveAsImage: {
                            title: 'ä¿å­˜å›¾åƒ',
                            name: sanitizeFileName('æ€§åˆ«è¯„ä»·å·®å¼‚æ¦‚è§ˆï¼ˆEDS / ECS / PBSï¼‰'),
                            pixelRatio: 2,
                        },
                    },
                    right: 12,
                    top: 12,
                },
            };
        };

        const renderImplicitCharts = () => {
            if (!state.implicitModels.length || !state.dimensions.length) return;
            const view = state.chartView.implicit;
            const dbsChart = createChart('public-implicit-dbs');
            if (dbsChart) {
                const option = view === 'radar'
                    ? getImplicitRadarOption('å„ç»´åº¦åˆ»æ¿å°è±¡ä¸€è‡´æ€§', 'dbs')
                    : getImplicitBarOption('å„ç»´åº¦åˆ»æ¿å°è±¡ä¸€è‡´æ€§', 'dbs');
                dbsChart.setOption(option, true);
            }

            const pbsChart = createChart('public-implicit-pbs');
            if (pbsChart) {
                const option = view === 'radar'
                    ? getImplicitRadarOption('å„ç»´åº¦æ€§åˆ«è¯„ä»·å·®å¼‚', 'pbs')
                    : getImplicitBarOption('å„ç»´åº¦æ€§åˆ«è¯„ä»·å·®å¼‚', 'pbs');
                pbsChart.setOption(option, true);
            }
        };

        const renderExplicitCharts = () => {
            if (!state.explicitOverall.length) return;
            const chart = createChart('public-explicit-metrics');
            if (!chart) return;
            const option = state.chartView.explicit === 'radar'
                ? getExplicitRadarOption()
                : getExplicitBarOption();
            chart.setOption(option, true);
        };

        const formatPercent = (value) => (value === null || value === undefined ? '-' : `${value.toFixed(2)}%`);

        const leaderboardHead = document.getElementById('leaderboard-head');
        const leaderboardBody = document.getElementById('leaderboard-body');
        const leaderboardSummary = document.getElementById('leaderboard-summary');
        const topnSelect = document.getElementById('leaderboard-topn');
        const tabButtons = Array.from(document.querySelectorAll('.leaderboard-tab'));

        const defaultSort = {
            implicit: { key: 'ibs', dir: 'desc' },
            explicit: { key: 'ecs', dir: 'desc' },
        };

        const columnsConfig = {
            implicit: [
                { key: 'model', label: 'æ¨¡å‹', sortable: false },
                { key: 'ibs', label: 'åˆ»æ¿ä¸€è‡´å¾—åˆ†', sortable: true },
                { key: 'pbs', label: 'æ€§åˆ«è¯„ä»·å·®å¼‚', sortable: true },
            ],
            explicit: [
                { key: 'model', label: 'æ¨¡å‹', sortable: false },
                { key: 'eds', label: 'å›ç­”åˆ†å¸ƒå·®å¼‚', sortable: true },
                { key: 'ecs', label: 'æƒ…æ™¯ä¸€è‡´æ€§å·®å¼‚', sortable: true },
                { key: 'pbs', label: 'æ€§åˆ«è¯„ä»·å·®å¼‚', sortable: true },
            ],
        };

        const leaderboardState = {
            view: 'implicit',
            sortKey: null,
            sortDir: 'desc',
            topN: 5,
        };

        const getActiveDataset = () => (leaderboardState.view === 'implicit' ? state.implicitOverall : state.explicitOverall);

        const applySort = (rows) => {
            const { sortKey, sortDir } = leaderboardState;
            if (!sortKey) return rows;
            const direction = sortDir === 'asc' ? 1 : -1;
            return [...rows].sort((a, b) => {
                const va = a[sortKey];
                const vb = b[sortKey];
                const safeA = va === null || va === undefined ? -Infinity : va;
                const safeB = vb === null || vb === undefined ? -Infinity : vb;
                if (safeA === safeB) return 0;
                return safeA > safeB ? direction : -direction;
            });
        };

        const applyTopN = (rows) => {
            if (leaderboardState.topN === 'all') return rows;
            const limit = parseInt(leaderboardState.topN, 10);
            if (Number.isNaN(limit)) return rows;
            return rows.slice(0, limit);
        };

        const renderHead = () => {
            const cols = columnsConfig[leaderboardState.view];
            const headRow = document.createElement('tr');
            cols.forEach((col) => {
                const th = document.createElement('th');
                th.textContent = col.label;
                if (col.sortable) {
                    th.dataset.sortKey = col.key;
                    th.classList.add('sortable');
                    if (leaderboardState.sortKey === col.key) {
                        th.classList.add(leaderboardState.sortDir === 'asc' ? 'sorted-asc' : 'sorted-desc');
                    }
                }
                headRow.appendChild(th);
            });
            leaderboardHead.innerHTML = '';
            leaderboardHead.appendChild(headRow);
        };

        const renderBody = () => {
            const dataset = applyTopN(applySort(getActiveDataset()));
            const cols = columnsConfig[leaderboardState.view];
            leaderboardBody.innerHTML = '';
            dataset.forEach((row) => {
                const tr = document.createElement('tr');
                cols.forEach((col) => {
                    const td = document.createElement('td');
                    if (col.key === 'model') {
                        td.textContent = row[col.key];
                    } else {
                        td.textContent = formatPercent(row[col.key]);
                    }
                    tr.appendChild(td);
                });
                leaderboardBody.appendChild(tr);
            });
        };

        const renderSummary = () => {
            const dataset = getActiveDataset();
            const total = dataset.length;
            if (!total) {
                leaderboardSummary.textContent = 'æš‚æ— è¯¥ç±»å‹çš„å…¬å¼€è¯„ä¼°ç»“æœã€‚';
                return;
            }
            const avg = (key) => {
                const valid = dataset.map(item => item[key]).filter(value => value !== null && value !== undefined);
                if (!valid.length) return '-';
                const mean = valid.reduce((sum, val) => sum + val, 0) / valid.length;
                return `${mean.toFixed(2)}%`;
            };
            if (leaderboardState.view === 'implicit') {
                leaderboardSummary.textContent = `å…±æœ‰ ${total} ä¸ªæ¨¡å‹å‚ä¸éšæ€§åè§è¯„ä¼°ï¼Œå¹³å‡åˆ»æ¿ä¸€è‡´å¾—åˆ† ${avg('ibs')}ï¼Œå¹³å‡æ€§åˆ«è¯„ä»·å·®å¼‚ ${avg('pbs')}ã€‚`;
            } else {
                leaderboardSummary.textContent = `å…±æœ‰ ${total} ä¸ªæ¨¡å‹å‚ä¸æ˜¾æ€§åè§è¯„ä¼°ï¼Œå¹³å‡å›ç­”åˆ†å¸ƒå·®å¼‚ ${avg('eds')}ã€æƒ…æ™¯ä¸€è‡´æ€§å·®å¼‚ ${avg('ecs')}ã€æ€§åˆ«è¯„ä»·å·®å¼‚ ${avg('pbs')}ï¼ˆæ•°å€¼è¶Šé«˜è¡¨ç¤ºç”·å¥³å›ç­”å·®è·è¶Šæ˜æ˜¾ï¼‰ã€‚`;
            }
        };

        const refreshLeaderboard = () => {
            if (!getActiveDataset().length) {
                leaderboardHead.innerHTML = '';
                leaderboardBody.innerHTML = '<tr><td class="tech-text-muted">æš‚æ— æ•°æ®</td></tr>';
                leaderboardSummary.textContent = 'æš‚æ— è¯¥ç±»å‹çš„å…¬å¼€è¯„ä¼°ç»“æœã€‚';
                return;
            }
            if (!leaderboardState.sortKey) {
                const defaults = defaultSort[leaderboardState.view];
                leaderboardState.sortKey = defaults.key;
                leaderboardState.sortDir = defaults.dir;
            }
            renderHead();
            renderBody();
            renderSummary();
        };

        const setActiveView = (view) => {
            if (leaderboardState.view === view) return;
            leaderboardState.view = view;
            leaderboardState.sortKey = null;
            tabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.view === view));
            refreshLeaderboard();
        };

        const closeMenus = () => {
            document.querySelectorAll('.menu-panel.show').forEach(panel => panel.classList.remove('show'));
        };

        document.querySelectorAll('.menu-trigger').forEach((button) => {
            const menuId = button.dataset.menu;
            const panel = document.getElementById(menuId);
            if (!panel) return;
            button.addEventListener('click', (event) => {
                event.stopPropagation();
                const isOpen = panel.classList.contains('show');
                closeMenus();
                if (!isOpen) {
                    panel.classList.add('show');
                }
            });
            panel.addEventListener('click', (event) => event.stopPropagation());
            panel.querySelectorAll('a').forEach(anchor => anchor.addEventListener('click', closeMenus));
        });

        document.addEventListener('click', closeMenus);
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') closeMenus();
        });

        document.querySelectorAll('[data-view-group]').forEach((button) => {
            button.addEventListener('click', () => {
                const group = button.dataset.viewGroup;
                const mode = button.dataset.viewMode;
                if (!group || !mode || !(group in state.chartView)) {
                    closeMenus();
                    return;
                }
                if (state.chartView[group] === mode) {
                    closeMenus();
                    return;
                }
                state.chartView[group] = mode;
                document.querySelectorAll(`[data-view-group="${group}"]`).forEach((btn) => {
                    btn.classList.toggle('active', btn === button);
                });
                if (group === 'implicit') {
                    renderImplicitCharts();
                } else if (group === 'explicit') {
                    renderExplicitCharts();
                }
                closeMenus();
            });
        });

        const escapeCSV = (value) => {
            if (value === null || value === undefined) return '';
            const str = String(value);
            return /[",\n]/.test(str) ? `"${str.replace(/"/g, '""')}"` : str;
        };

        const triggerCSVDownload = (filename, rows) => {
            const csv = rows.map(row => row.map(escapeCSV).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        };

        const exportCurrentLeaderboard = () => {
            const dataset = applyTopN(applySort(getActiveDataset()));
            if (!dataset.length) {
                closeMenus();
                return;
            }
            const cols = columnsConfig[leaderboardState.view];
            const header = cols.map(col => col.label);
            const body = dataset.map(row =>
                cols.map(col => {
                    if (col.key === 'model') return row[col.key];
                    const value = row[col.key];
                    return value === null || value === undefined ? '' : value.toFixed(2);
                })
            );
            const filename = leaderboardState.view === 'implicit' ? 'implicit_leaderboard.csv' : 'explicit_leaderboard.csv';
            triggerCSVDownload(filename, [header, ...body]);
            closeMenus();
        };

        const leaderboardExportBtn = document.querySelector('[data-action="leaderboard-export-view"]');
        if (leaderboardExportBtn) {
            leaderboardExportBtn.addEventListener('click', exportCurrentLeaderboard);
        }

        const saveChartImage = (chartId, filename) => {
            const chart = chartMap[chartId];
            if (!chart) return;
            const dataURL = chart.getDataURL({ type: 'png', pixelRatio: 2, backgroundColor: '#ffffff' });
            const link = document.createElement('a');
            link.href = dataURL;
            link.download = filename || `${chartId}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        document.querySelectorAll('[data-chart-save]').forEach((button) => {
            button.addEventListener('click', () => {
                saveChartImage(button.dataset.chartSave, button.dataset.filename);
                closeMenus();
            });
        });

        const initLeaderboard = () => {
            tabButtons.forEach((btn) => {
                btn.addEventListener('click', () => setActiveView(btn.dataset.view));
            });

            leaderboardHead.addEventListener('click', (event) => {
                const target = event.target.closest('[data-sort-key]');
                if (!target) return;
                const key = target.dataset.sortKey;
                if (leaderboardState.sortKey === key) {
                    leaderboardState.sortDir = leaderboardState.sortDir === 'asc' ? 'desc' : 'asc';
                } else {
                    leaderboardState.sortKey = key;
                    leaderboardState.sortDir = 'desc';
                }
                renderHead();
                renderBody();
            });

            topnSelect.addEventListener('change', (event) => {
                leaderboardState.topN = event.target.value;
                refreshLeaderboard();
            });

            if (!state.implicitOverall.length && state.explicitOverall.length) {
                setActiveView('explicit');
                tabButtons.find(btn => btn.dataset.view === 'implicit')?.setAttribute('disabled', 'disabled');
            }

            if (state.implicitOverall.length <= 5 && state.explicitOverall.length <= 5) {
                topnSelect.value = 'all';
                topnSelect.parentElement.style.display = 'none';
                leaderboardState.topN = 'all';
            }

            refreshLeaderboard();
        };

        const initCharts = () => {
            renderImplicitCharts();
            renderExplicitCharts();
        };

        const initialize = async () => {
            try {
                showStatus('æ­£åœ¨åŠ è½½æ•°æ®ï¼Œè¯·ç¨å€™â€¦', 'info');
                const missing = [];
                for (const file of REQUIRED_FILES) {
                    const exists = await fetch(`${DATA_PATH}${file}`, { method: 'HEAD' }).then(res => res.ok).catch(() => false);
                    if (!exists) missing.push(file);
                }
                if (missing.length) {
                    showStatus(`ç¼ºå°‘æ•°æ®æ–‡ä»¶ï¼š${missing.join(', ')}ã€‚è¯·å°†ç¦»çº¿ç”Ÿæˆçš„æ–‡ä»¶æ”¾å…¥ data/ ç›®å½•ã€‚`, 'warning');
                    return;
                }

                const [metricsRes, overallRes] = await Promise.all([
                    fetch(`${DATA_PATH}public_metrics.json`),
                    fetch(`${DATA_PATH}public_overall.json`),
                ]);
                if (!metricsRes.ok || !overallRes.ok) {
                    showStatus('æ— æ³•åŠ è½½ JSON æ•°æ®ï¼Œè¯·æ£€æŸ¥ data/ ç›®å½•ã€‚', 'warning');
                    return;
                }

                state.metricsData = await metricsRes.json();
                state.overallData = await overallRes.json();

                state.implicitMetrics = state.metricsData.filter(item => item.kind === 'implicit');
                state.explicitMetrics = state.metricsData.filter(item => item.kind === 'explicit');
                state.implicitOverall = state.overallData.filter(item => item.kind === 'implicit');
                state.explicitOverall = state.overallData.filter(item => item.kind === 'explicit');

                state.implicitModels = [...new Set(state.implicitMetrics.map(item => item.model))];
                state.dimensions = [...new Set(state.implicitMetrics.map(item => item.dimension_code))];
                state.dimensionLabels = {};
                state.implicitMetricMap = {};
                state.implicitMetrics.forEach(item => {
                    state.dimensionLabels[item.dimension_code] = item.dimension;
                    state.implicitMetricMap[`${item.model}|${item.dimension_code}`] = item;
                });

                hideStatus();
                initLeaderboard();
                initCharts();

                document.body.classList.add('data-loaded');
            } catch (error) {
                console.error(error);
                showStatus('åŠ è½½æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æˆ–é‡æ–°ç”Ÿæˆæ•°æ®ã€‚', 'warning');
            }
        };

        initialize();

        window.addEventListener('resize', () => {
            chartInstances.forEach(chart => chart.resize());
        });
    </script>
</body>
</html>
